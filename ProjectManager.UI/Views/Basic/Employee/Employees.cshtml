@using System.Globalization
@using ProjectManager.Application.Employees.Queries.GetEmployeeBasicsQuery

@model IEnumerable<EmployeeBasicsDto>

@{
    ViewData["Title"] = "Pracownicy";
    var locale = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
}

@section Styles {
    <partial name="Styles/_DataTablesStyles" />
}

<partial name="Modals/_ModalConfirm"
         model="@(new ModalParams
         {
             Id = "modal-confirm-delete",
             Title = "Potwierdź proszę",
             Description = "Czy na pewno chcesz usunąć wybranego pracownika?"
         })" />
<partial name="_Overlay" />
<div class="card card-primary card-border-top">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">
            <i class="fas fa-solid fa-people-group"></i>Lista pracowników
        </h3>

        <a href="/Employee/AddEmployee" class="btn btn-primary">
            <i class="fas fa-circle-plus me-1"></i>Dodaj pracownika
        </a>
    </div>

    <div class="card-body">

        <div class="form-check form-switch mb-4">
            <input type="checkbox"
                   class="form-check-input"
                   id="isActiveUserCb"
                   onclick="refreshTable();" />
            <label class="form-check-label" for="isActiveUserCb">
                Wszyscy
            </label>
        </div>

        <table id="employees" class="table table-striped table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Nazwa pracownika</th>
                    <th class="desktop">Email</th>
                    <th class="desktop">Numer telefonu</th>
                    <th class="desktop" style="display:none;">IsDeleted</th>
                    <th class="desktop text-center" style="width: 180px;">Akcje</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var employee in Model)
                {
                    <tr>
                        <td>
                            <a class="edit-link fw-semibold"
                               href="/Employee/EditEmployee?employeeId=@employee.Id">
                                @employee.Name
                            </a>
                        </td>

                        <td>@employee.Email</td>
                        <td>@employee.PhoneNumber</td>

                        <td>@(employee.IsDeleted ? "1" : "0")</td>

                        <td class="text-center">

                            @if (employee.IsDeleted)
                            {
                                <span class="badge bg-secondary px-3 py-2">
                                    Nie pracuje
                                </span>
                            }
                            else
                            {
                                <a href="/Employee/EditEmployee?employeeId=@employee.Id"
                                   class="btn btn-success btn-sm me-1">
                                    <i class="fas fa-pen-to-square me-1"></i>Edytuj
                                </a>

                                <button class="btn btn-danger btn-sm"
                                        onclick="deleteEmployee('@employee.Id', this)">
                                    <i class="fas fa-trash-can me-1"></i>Usuń
                                </button>
                            }

                        </td>
                    </tr>
                }
            </tbody>
        </table>

    </div>
</div>

@section Scripts {
    <partial name="Scripts/_DataTablesScripts" />

    <script>

        let dtEmployees;
        let selectedRow = null;
        let selectedEmployeeId = null;

        $(document).ready(function () {

            // restore checkbox state from cookie
            $('#isActiveUserCb').prop('checked', $.cookie("isActiveUserCb") === "1");

            $('#isActiveUserCb').change(function () {
                const val = this.checked ? "1" : "0";
                $.cookie("isActiveUserCb", val, { path: '/Employee', expires: 365 });
            });

            dtEmployees = $('#employees').DataTable({
                paging: true,
                ordering: true,
                info: true,
                responsive: true,
                autoWidth: false,
                lengthChange: true,
                language: {
                    url: `/lib/datatables/lang/${'@locale'}.json`
                },
                order: [[0, "asc"]],
                columnDefs: [
                    { targets: 3, visible: false, searchable: false }
                ]
            });

        });

        // custom filter
        $.fn.dataTable.ext.search.push(function (settings, data) {

            const showAll = $('#isActiveUserCb').is(":checked");
            const isDeleted = parseInt(data[3]);

            if (showAll && isDeleted === 1)
                return false;

            return true;
        });

        function refreshTable() {
            dtEmployees.draw();
        }

        function deleteEmployee(id, btn) {
            selectedRow = btn.closest("tr");
            selectedEmployeeId = id;

            $('#modal-confirm-delete').modal('show');
            $('.loading-overlay').show();
        }

        $('#modal-confirm-delete-btn').on('click', function () {

            $('#modal-confirm-delete').modal('hide');

            const errorMessage =
                'Błąd. Nie udało się usunąć wybranego pracownika. Spróbuj ponownie lub skontaktuj się z administratorem.';

            $.ajax({
                type: "POST",
                url: "/User/DeleteUser",
                data: { id: selectedEmployeeId },
                dataType: "json",

                success: function (data) {
                    if (data.success) {
                        location.reload();
                        toastr.success('Dane zostały zaktualizowane.');
                    } else {
                        toastr.error(errorMessage);
                        $('.loading-overlay').hide();
                    }
                },

                error: function () {
                    toastr.error(errorMessage);
                    $('.loading-overlay').hide();
                }
            });

        });

    </script>
}
