Zbuduj kod do tworzenia nowej encji Settlement wg poniższych warunków:
Mamy tabelę szablonu
public class WorkScopeTemplate
{
    public int Id { get; set; }
    public string Description { get; set; }
    public ProjectType ProjectType { get; set; }
    public WorkScopeType WorkScopeType { get; set; }
    public int Order { get; set; }
    public ICollection<WorkScopePositionTemplate> WorkScopePositions { get; set; } = new HashSet<WorkScopePositionTemplate>();
}

oraz 
public class WorkScopePositionTemplate
{
    public int Id { get; set; }
    public int WorkScopeTemplateId { get; set; }
    public WorkScopeTemplate WorkScopeTemplate { get; set; }
    public string Description { get; set; }
    public int Order { get; set; }
}

Chcemy stworzyć nowy Settlement zawierajacy wszystkie encje z WorkScopeTemplate oraz WorkScopePositionTemplate. Struktura enitity dla Settlement wygląda nastęująco:
public class Settlement
{
    public int Id { get; set; }
    public int ProjectId { get; set; }
    public Project Project { get; set; }
    public Assumption Assumption { get; set; }
    public string UserId { get; set; }
    public ApplicationUser User { get; set; }
    public DateTime CreatedAt { get; set; }
    public ICollection<Invoice> Invoices { get; set; } = new HashSet<Invoice>();
    public ICollection<WorkScope> WorkScopes { get; set; } = new HashSet<WorkScope>();
}

public class Assumption
{
    public int Id { get; set; }
    public int SettlementId { get; set; }
    public Settlement Settlement { get; set; }
    public decimal MarginGen { get; set; }
    public decimal MarginInstall { get; set; }
    public decimal Discount { get; set; }
    public int Maturity { get; set; }
    public decimal CompanyCost { get; set; }
    public decimal CompanyGuarantee { get; set; }
    public decimal Insurance { get; set; }
}
public class WorkScope
{
    public int Id { get; set; }
    public int SettlementId { get; set; }
    public Settlement Settlement { get; set; }
    public WorkScopeType WorkScopeType { get; set; }
    public string Description { get; set; }
    public int Order { get; set; }
    public ICollection<WorkScopeOffer> WorkScopeOffers { get; set; } = new HashSet<WorkScopeOffer>();
    public ICollection<WorkScopeCost> WorkScopeCosts { get; set; } = new HashSet<WorkScopeCost>();
    public ICollection<Invoice> Invoices { get; set; } = new HashSet<Invoice>();
}
public class WorkScopeOffer
{
    public int Id { get; set; }
    public int WorkScopeId { get; set; }
    public WorkScope WorkScope { get; set; }
    public string Description { get; set; }
    public string Comment { get; set; }
    public int Order { get; set; }
    public bool IsUsed { get; set; }
    public UnitType UnitType { get; set; }
    public int Quantity { get; set; }
    public decimal NetAmount { get; set; }
    public decimal EuroNetAmount { get; set; }
    public decimal EuroRate { get; set; }
    public int SubContractorId { get; set; }
    public SubContractor SubContractor { get; set; }
}
public class WorkScopeCost
{
    public int Id { get; set; }
    public int WorkScopeId { get; set; }
    public WorkScope WorkScope { get; set; }
    public string Description { get; set; }
    public CostStatusType CostStatusType { get; set; }
    public int Order { get; set; }
    public UnitType UnitType { get; set; }
    public int Quantity { get; set; }
    public decimal NetAmount { get; set; }
    public decimal EuroNetAmount { get; set; }
    public decimal EuroRate { get; set; }
    public int SubContractorId { get; set; }
    public SubContractor SubContractor { get; set; }



public async Task<Settlement> CreateSettlementFromTemplateAsync(
    int projectId,
    string userId,
    ProjectType projectType)
{
    // 1. Pobranie szablonów
    var templates = await _context.WorkScopeTemplates
        .Include(x => x.WorkScopePositions)
        .Where(x => x.ProjectType == projectType)
        .OrderBy(x => x.Order)
        .ToListAsync();

    if (!templates.Any())
        throw new InvalidOperationException("Brak szablonów dla podanego typu projektu.");

    // 2. Utworzenie Settlement
    var settlement = new Settlement
    {
        ProjectId = projectId,
        UserId = userId,
        CreatedAt = DateTime.UtcNow,
        Assumption = new Assumption
        {
            MarginGen = 0,
            MarginInstall = 0,
            Discount = 0,
            Maturity = 30,
            CompanyCost = 0,
            CompanyGuarantee = 0,
            Insurance = 0
        }
    };

    // 3. Tworzenie WorkScope na podstawie szablonów
    foreach (var template in templates)
    {
        var workScope = new WorkScope
        {
            WorkScopeType = template.WorkScopeType,
            Description = template.Description,
            Order = template.Order
        };

        // 4. Tworzenie pozycji WorkScope (Offer/Cost)
        foreach (var pos in template.WorkScopePositions.OrderBy(p => p.Order))
        {
            // Wariant A: Każda pozycja to WorkScopeOffer
            workScope.WorkScopeOffers.Add(new WorkScopeOffer
            {
                Description = pos.Description,
                Comment = string.Empty,
                Order = pos.Order,
                IsUsed = true,
                UnitType = UnitType.Unit, // domyślna wartość
                Quantity = 1,
                NetAmount = 0,
                EuroNetAmount = 0,
                EuroRate = 0,
                SubContractorId = 0
            });

            // Wariant B: Jeśli chcesz również WorkScopeCost – odkomentuj:
            /*
            workScope.WorkScopeCosts.Add(new WorkScopeCost
            {
                Description = pos.Description,
                Order = pos.Order,
                CostStatusType = CostStatusType.Unknown,
                UnitType = UnitType.Unit,
                Quantity = 1,
                NetAmount = 0,
                EuroNetAmount = 0,
                EuroRate = 0,
                SubContractorId = 0
            });
            */
        }

        settlement.WorkScopes.Add(workScope);
    }

    // 5. Zapis do bazy
    _context.Settlements.Add(settlement);
    await _context.SaveChangesAsync();

    return settlement;
}

}